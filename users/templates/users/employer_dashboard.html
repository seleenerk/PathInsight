{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Employer Dashboard - PathInsight</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6f8;
    }

    .sidebar {
      width: 220px;
      background-color: #2f3e46;
      height: 100vh;
      position: fixed;
      padding-top: 30px;
      color: white;
      display: flex;
      flex-direction: column;
    }

    .sidebar h2 {
      text-align: center;
      margin-bottom: 30px;
      color: white;
    }

    .sidebar a {
      display: block;
      padding: 12px 20px;
      text-decoration: none;
      color: white;
      transition: background 0.3s;
    }

    .sidebar a:hover {
      background-color: #354f52;
    }

    .sidebar a.active {
      background-color: #3d4d40;
      font-weight: bold;
    }

    .main-content {
      margin-left: 220px;
      padding: 30px;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .card {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    button, .btn {
      background-color: #a1a695;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s;
    }

    button:hover, .btn:hover {
      background-color: #7c8373;
    }

    h2, h3 {
      color: #2f3e46;
    }

    .dashboard-overview {
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
      margin-top: 20px;
    }

    .overview-box {
      flex: 1;
      min-width: 200px;
      background-color: #ffffff;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: center;
    }

    .overview-box p {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0 0;
    }

    .overview-box small {
      font-size: 14px;
      color: #777;
    }

    #logout-form {
      display: none;
    }

    .applications-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }

    .application-card {
      width: 280px;
      background-color: #f4f6f8;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .create-job-form {
      max-width: 600px;
      margin: auto;
    }

    .create-job-form label {
      display: block;
      font-weight: bold;
      margin-bottom: 6px;
      margin-top: 20px;
      color: #2f3e46;
    }

    .create-job-form input[type="text"],
    .create-job-form textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
    }

    .create-job-form small {
      display: block;
      color: #555;
      margin-top: 5px;
    }
  </style>
</head>
<body>

<div class="sidebar">
  <h2>Employer</h2>
  <a href="#" data-section="dashboard">Dashboard</a>
  <a href="#" data-section="profile">Profile</a>
  <a href="#" data-section="create_job">Create New Job</a>
  <a href="#" data-section="job_postings">Job Postings</a>
  <a href="#" onclick="document.getElementById('logout-form').submit(); return false;">Logout</a>
  <form id="logout-form" method="post" action="{% url 'users:logout' %}">{% csrf_token %}</form>
</div>

<div class="main-content">
  {% if messages %}
    <div id="message-box" class="auto-dismiss" style="
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      padding: 12px 20px;
      margin-bottom: 20px;
      border-radius: 6px;
      transition: opacity 0.5s ease;
    ">
      {% for message in messages %}
        <p style="margin: 0; font-weight: bold;">{{ message }}</p>
      {% endfor %}
    </div>
  {% endif %}
  
  <!-- Dashboard Section -->
  <div id="dashboard" class="section active card">
    <h2>Welcome, {{ request.user.username }}</h2>
    <div class="dashboard-overview">
      <div class="overview-box">
        <h3>Total Job Postings</h3>
        <p>{{ total_job_posts }}</p>
        <small>Jobs you've posted</small>
      </div>
      <div class="overview-box">
        <h3>Total Applications</h3>
        <p>{{ total_applications }}</p>
        <small>Applications received</small>
      </div>
      <div class="overview-box">
        <h3>Last Job Posted</h3>
        {% if last_job %}
          <p style="font-size: 18px;">{{ last_job.title }}</p>
          <small>{{ last_job.created_at|date:"F d, Y" }}</small>
        {% else %}
          <p>No jobs posted</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Profile Section -->
  <div id="profile" class="section card" style="max-width: 800px; margin: auto;">
    <div id="employer-profile-view">
      <h2>Profile</h2>
      <p><strong>Company Name:</strong> {{ employer.company_name }}</p>
      <p><strong>Company Description:</strong> {{ employer.company_description }}</p>
      <p><strong>Website:</strong> <a href="{{ employer.website }}" target="_blank">{{ employer.website }}</a></p>
      <p><strong>Industry:</strong> {{ employer.industry }}</p>
      <p><strong>Company Size:</strong> {{ employer.company_size }}</p>
      <p><strong>Founded Year:</strong> {{ employer.founded_year }}</p>
      <p><strong>Location:</strong> {{ employer.location }}</p>
      <p><strong>Contact Email:</strong> {{ employer.contact_email }}</p>
      <p><strong>LinkedIn URL:</strong> <a href="{{ employer.linkedin_url }}" target="_blank">{{ employer.linkedin_url }}</a></p>
      <div style="text-align: center; margin-top: 20px;">
        <button onclick="toggleEmployerEdit(true)" class="btn">Edit Profile</button>
      </div>
    </div>
    <div id="employer-profile-edit" style="display: none;">
      <h2>Edit Profile</h2>
      <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <div style="text-align: center; margin-top: 20px;">
          <button type="submit" class="btn">Save</button>
          <button type="button" onclick="toggleEmployerEdit(false)" class="btn" style="background-color: #999;">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create Job Section -->
  <div id="create_job" class="section card" style="max-width: 700px; margin: auto;">
    <h2 style="text-align: center;">Create a New Job</h2>
    <form method="post" action="{% url 'users:create_job_posting' %}" class="create-job-form">
      {% csrf_token %}
      <label for="id_title">Title:</label>
      {{ job_posting_form.title }}

      <label for="id_description">Description:</label>
      {{ job_posting_form.description }}

      <label for="id_required_skills">Required Skills:</label>
      {{ job_posting_form.required_skills }}
      <small>Enter as comma-separated values (e.g. Python, Django, SQL)</small>

      <label for="id_preferred_traits">Preferred Traits:</label>
      {{ job_posting_form.preferred_traits }}
      <small>Describe the personal traits or soft skills you're looking for (e.g. teamwork, creativity)</small>

      <div style="text-align: center; margin-top: 30px;">
        <button type="submit" class="btn">Create Job</button>
      </div>
    </form>

    <div class="card" style="margin-top: 40px; background-color: #f9f9f9; padding: 20px;">
      <h3 style="color: #2e4f4f; margin-bottom: 20px;">Company Information</h3>
      <p><strong>Company Name:</strong> {{ employer.company_name }}</p>
      <p><strong>Industry:</strong> {{ employer.industry }}</p>
      <p><strong>Founded Year:</strong> {{ employer.founded_year }}</p>
      <p><strong>Location:</strong> {{ employer.location }}</p>
    </div>
  </div>

  <!-- Job Postings Section -->
  <div id="job_postings" class="section card">
    <h2>Job Postings</h2>
    {% for job in job_posts %}
      <div class="card" id="job-card-{{ job.id }}">
        {% if edit_job_id == job.id %}
          <form method="post" action="{% url 'users:edit_job_posting' job.id %}" style="max-width: 600px;">
            {% csrf_token %}

            <div style="margin-bottom: 15px;">
              <label for="id_title"><strong>Title:</strong></label>
              {{ job_posting_form.title }}
            </div>

            <div style="margin-bottom: 15px;">
              <label for="id_description"><strong>Description:</strong></label>
              {{ job_posting_form.description }}
            </div>

            <div style="margin-bottom: 15px;">
              <label for="id_required_skills"><strong>Required Skills:</strong></label>
              {{ job_posting_form.required_skills }}
            </div>

            <div style="margin-bottom: 15px;">
              <label for="id_preferred_traits"><strong>Preferred Traits:</strong></label>
              {{ job_posting_form.preferred_traits }}
            </div>

            <div style="margin-top: 20px;">
              <button type="submit" class="btn">Save</button>
              <button type="button" onclick="cancelEdit({{ job.id }})" class="btn" style="background-color:#6c757d;">Cancel</button>
            </div>
          </form>
        {% else %}
          <h3>{{ job.title }}</h3>
          <p><strong>Company Name:</strong> {{ job.employer.company_name }}</p>
          <p><strong>Industry:</strong> {{ job.employer.industry }}</p>
          <p><strong>Founded:</strong> {{ job.employer.founded_year }}</p>
          <p><strong>Location:</strong> {{ job.employer.location }}</p>
          <p><strong>Website:</strong> <a href="{{ job.employer.website }}" target="_blank">{{ job.employer.website }}</a></p>
          <p><strong>Description:</strong> {{ job.description }}</p>
          <p><strong>Required Skills:</strong> {{ job.required_skills }}</p>
          <p><strong>Preferred Traits:</strong> {{ job.preferred_traits }}</p>

          <form method="post" action="{% url 'users:edit_job_posting' job.id %}" style="display:inline;">
            {% csrf_token %}
            <input type="hidden" name="edit" value="true">
            <button type="submit" class="btn">Edit</button>
          </form>
          <form method="post" action="{% url 'users:delete_job_posting' job.pk %}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this job posting?');">
            {% csrf_token %}
            <button type="submit" class="btn" style="background-color:#d9534f;">Delete</button>
          </form>

          <div class="applications-container">
            {% for application in job.applications_list %}
              <div class="application-card">
                <p><strong>Applicant:</strong> {{ application.jobseeker.user.username }}</p>
                <p><strong>Applied At:</strong> {{ application.application_date|date:"F d, Y H:i" }}</p>
                <p>
                  <a href="{% url 'users:view_applicant_profile' application.jobseeker.id %}" class="btn">View Full Profile</a>
                  <a href="{{ application.jobseeker.cv_file_path.url }}" class="btn" style="background-color:#6c757d;" target="_blank">View CV</a>
                </p>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    {% empty %}
      <p>No job postings yet.</p>
    {% endfor %}
  </div>

<script>
  function showSection(sectionId) {
    document.querySelectorAll('.section').forEach(section => {
      section.classList.remove('active');
    });

    const target = document.getElementById(sectionId);
    if (target) {
      target.classList.add('active');
      localStorage.setItem('activeEmployerSection', sectionId);

      if (sectionId === 'profile') {
        toggleEmployerEdit(false);
      }

    }
  }

  document.addEventListener("DOMContentLoaded", function () {
   
    document.querySelectorAll('.sidebar a[data-section]').forEach(link => {
      link.addEventListener('click', function (e) {
        e.preventDefault();
        document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
        this.classList.add('active');
        showSection(this.getAttribute('data-section'));
      });
    });

    const savedSection = localStorage.getItem('activeEmployerSection') || 'dashboard';
    showSection(savedSection);
    const activeLink = document.querySelector(`.sidebar a[data-section="${savedSection}"]`);
    if (activeLink) activeLink.classList.add('active');


    const messageBox = document.getElementById("message-box");
    if (messageBox) {
      setTimeout(() => {
        messageBox.style.transition = "opacity 0.5s ease";
        messageBox.style.opacity = "0";

        setTimeout(() => {
          if (messageBox.parentNode) {
            messageBox.remove();
          }
        }, 500); 
      }, 3000);
    }
  });

  function toggleEmployerEdit(editMode) {
    const viewDiv = document.getElementById("employer-profile-view");
    const editDiv = document.getElementById("employer-profile-edit");

    if (viewDiv && editDiv) {
      viewDiv.style.display = editMode ? "none" : "block";
      editDiv.style.display = editMode ? "block" : "none";
    }
  }

  function cancelEdit(jobId) {
    location.reload();
  }


  
</script>

</body>
</html>


